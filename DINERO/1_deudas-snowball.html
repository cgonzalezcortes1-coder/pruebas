<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2d5016">
    <meta name="description" content="Controla tus deudas con el m√©todo Snowball">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Liberador">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>M√©todo Snowball - Liberador de Deudas</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f8f4ed;
            --bg-card: #ffffff;
            --primary: #2d5016;
            --primary-light: #4a7c2c;
            --accent-green: #7fb069;
            --accent-red: #d94e4e;
            --accent-yellow: #f2cc8f;
            --accent-blue: #3d8fb8;
            --text-dark: #1a1a1a;
            --text-medium: #5a5a5a;
            --text-light: #8a8a8a;
            --shadow: rgba(45, 80, 22, 0.08);
            --border: #e0dcd0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--bg-main);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
        }

        .subtitle {
            color: var(--accent-yellow);
            font-size: 1.1rem;
            font-weight: 500;
            position: relative;
        }

        /* Progress Overview */
        .overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow);
            border-left: 5px solid var(--accent-green);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Oswald', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-value.debt {
            color: var(--accent-red);
        }

        .stat-value.paid {
            color: var(--accent-green);
        }

        /* Overall Progress Bar */
        .total-progress {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow);
            margin-bottom: 40px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
            color: var(--primary);
            text-transform: uppercase;
        }

        .progress-percentage {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--accent-green);
            font-weight: 700;
        }

        .progress-track {
            height: 30px;
            background: #e8e4d9;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, var(--primary-light) 100%);
            border-radius: 15px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Debts Section */
        .debts-container {
            display: grid;
            gap: 25px;
        }

        .debt-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px var(--shadow);
            border-top: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .debt-card:hover {
            box-shadow: 0 10px 35px var(--shadow);
        }

        .debt-card.priority {
            border-top-color: var(--accent-red);
            background: linear-gradient(to bottom, #fff5f5 0%, var(--bg-card) 50px);
        }

        .debt-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .debt-name {
            font-family: 'Oswald', sans-serif;
            font-size: 1.8rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .priority-badge {
            background: var(--accent-red);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .debt-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-main);
            border-radius: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.85rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-family: 'Oswald', sans-serif;
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 600;
        }

        .debt-progress {
            margin-bottom: 20px;
        }

        .debt-progress-bar {
            height: 20px;
            background: #e8e4d9;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .debt-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent-green) 100%);
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .debt-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-medium);
        }

        /* Payment Form */
        .payment-form {
            background: var(--bg-main);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .form-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-bottom: 8px;
            font-weight: 500;
        }

        input {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(127, 176, 105, 0.1);
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .btn-secondary {
            background: var(--accent-yellow);
            color: var(--primary);
        }

        .btn-secondary:hover {
            background: #e6bb7a;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #c43d3d;
        }

        /* Add Debt Form */
        .add-debt-section {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow);
            margin-bottom: 40px;
        }

        .add-debt-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapse-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
            color: var(--accent-green);
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0 !important;
        }

        .section-toggle-btn {
            background: transparent;
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .section-toggle-btn:hover {
            background: var(--accent-green);
            color: white;
            transform: translateY(-2px);
        }

        .section-toggle-btn.active {
            background: var(--accent-green);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .form-grid { grid-template-columns: 1fr; }
            .add-debt-form { grid-template-columns: 1fr; }
            .debt-header { flex-direction: column; align-items: flex-start; }
        }

        /* Celebration */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .celebration.show {
            display: block;
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .celebration h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 3rem;
            color: var(--accent-green);
            margin-bottom: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        /* Extra Payment Modal */
        .extra-payment-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 600px;
            width: 90%;
            display: none;
            border: 3px solid var(--accent-yellow);
        }

        .extra-payment-modal.show {
            display: block;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: var(--text-medium);
            font-size: 1rem;
            line-height: 1.6;
        }

        .modal-body {
            background: linear-gradient(135deg, #fff9e6 0%, #fffef8 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .modal-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent-yellow);
        }

        .modal-info strong {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .btn-cancel {
            background: var(--text-light);
            color: white;
        }

        .btn-cancel:hover {
            background: var(--text-medium);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Liberador de Deudas</h1>
            <p class="subtitle">M√©todo Snowball - Visualiza tu progreso hacia la libertad financiera</p>
            <button id="installButton" style="display: none; margin-top: 15px; background: var(--accent-yellow); color: var(--primary); padding: 12px 25px; border: none; border-radius: 8px; font-family: 'Oswald', sans-serif; font-weight: 600; cursor: pointer;">
                üì± Instalar App en tu celular
            </button>
        </header>

        <!-- Overview Stats -->
        <div class="overview">
            <div class="stat-box">
                <div class="stat-label">Deuda Total</div>
                <div class="stat-value debt" id="totalDebt">$0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Ya Pagado</div>
                <div class="stat-value paid" id="totalPaid">$0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Deudas Activas</div>
                <div class="stat-value" id="activeDebts">0</div>
            </div>
        </div>

        <!-- Total Progress -->
        <div class="total-progress">
            <div class="progress-header">
                <div class="progress-title">Progreso Total</div>
                <div class="progress-percentage" id="totalProgress">0%</div>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="totalProgressBar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Add New Debt -->
        <button class="section-toggle-btn" onclick="toggleSection('addDebtSection')" id="addDebtToggle">
            ‚ûï Agregar Nueva Deuda
        </button>
        <div class="add-debt-section collapsed" id="addDebtSection" style="transition: max-height 0.4s ease, opacity 0.3s ease, margin 0.3s ease; overflow: hidden; max-height: 0; opacity: 0;">
            <h2 class="form-title">Agregar Nueva Deuda</h2>
            <div class="add-debt-form">
                <div class="form-group">
                    <label>Nombre de la Deuda</label>
                    <input type="text" id="newDebtName" placeholder="Ej: Tarjeta Banamex">
                </div>
                <div class="form-group">
                    <label>Monto Inicial ($)</label>
                    <input type="number" id="newDebtInitial" placeholder="10000" step="0.01">
                </div>
                <div class="form-group">
                    <label>Saldo Actual ($)</label>
                    <input type="number" id="newDebtCurrent" placeholder="8000" step="0.01">
                </div>
                <div class="form-group">
                    <label>Frecuencia de Pago</label>
                    <select id="newDebtFrequency" style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif;">
                        <option value="Quincenal">Quincenal</option>
                        <option value="Mensual">Mensual</option>
                        <option value="Semanal">Semanal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo de Pago</label>
                    <select id="newDebtPaymentType" onchange="togglePaymentType()" style="padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-family: 'Work Sans', sans-serif;">
                        <option value="regular">Regular (mismo monto)</option>
                        <option value="irregular">Irregular (montos variables)</option>
                    </select>
                </div>
                <div class="form-group" id="regularPaymentGroup">
                    <label>Pago Regular ($)</label>
                    <input type="number" id="newDebtPayment" placeholder="500" step="0.01">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <button class="btn-primary" onclick="addDebt()">Agregar Deuda</button>
                </div>
            </div>
        </div>

        <!-- Debts List -->
        <div class="debts-container" id="debtsContainer"></div>

    </div>

    <!-- Extra Payment Modal -->
    <div class="extra-payment-modal" id="extraPaymentModal">
        <div class="modal-header">
            <div class="modal-title">üí∞ Actualizar despu√©s de Pago Adelantado</div>
            <div class="modal-subtitle">
                Cuando haces un pago extra, tu prestamista recalcula los intereses y te da un nuevo saldo total
            </div>
        </div>
        
        <div class="modal-body">
            <div class="modal-info">
                <strong>Deuda:</strong> <span id="modalDebtName"></span><br>
                <strong>Saldo actual en la app:</strong> <span id="modalCurrentBalance"></span>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                <p style="color: var(--text-medium); margin-bottom: 15px; font-size: 0.95rem; line-height: 1.6;">
                    <strong style="color: var(--primary);">üìû Paso 1:</strong> Hiciste tu pago adelantado al prestamista<br>
                    <strong style="color: var(--primary);">üìã Paso 2:</strong> Tu prestamista te dio el <strong>nuevo saldo total</strong><br>
                    <strong style="color: var(--primary);">‚úçÔ∏è Paso 3:</strong> Escribe ese nuevo saldo aqu√≠ abajo:
                </p>
                
                <label style="display: block; font-weight: 600; color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">
                    Nuevo Saldo Total (seg√∫n prestamista):
                </label>
                <input type="number" id="modalNewBalance" placeholder="15300.00" step="0.01"
                       style="width: 100%; padding: 15px; border: 3px solid var(--accent-yellow); 
                              border-radius: 8px; font-size: 1.3rem; font-weight: 700; 
                              font-family: 'Oswald', sans-serif; text-align: center;">
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-green);">
                <p style="color: var(--primary); font-size: 0.9rem; margin: 0;">
                    üí° <strong>Nota:</strong> El nuevo saldo ser√° menor que si solo restaras tu pago, 
                    porque te ahorras los intereses futuros. ¬°Eso es bueno!
                </p>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeExtraPaymentModal()">Cancelar</button>
            <button class="btn-primary" onclick="confirmExtraPayment()">‚úÖ Actualizar Saldo</button>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div class="overlay" id="overlay" onclick="closeModals()"></div>
    <div class="celebration" id="celebration">
        <h2>üéâ ¬°DEUDA LIQUIDADA! üéâ</h2>
        <p style="font-size: 1.2rem; color: var(--text-medium); margin-bottom: 20px;">¬°Felicidades! Has terminado de pagar una deuda completa.</p>
        <button class="btn-primary" onclick="closeCelebration()">Continuar</button>
    </div>

    <script>
        let debts = [];

        // Load data
        function loadData() {
            const saved = localStorage.getItem('snowballDebts');
            if (saved) {
                debts = JSON.parse(saved);
            }
            render();
        }

        // Save data
        function saveData() {
            localStorage.setItem('snowballDebts', JSON.stringify(debts));
        }

        // Toggle payment type visibility
        function togglePaymentType() {
            const paymentType = document.getElementById('newDebtPaymentType').value;
            const regularGroup = document.getElementById('regularPaymentGroup');
            
            if (paymentType === 'irregular') {
                regularGroup.style.display = 'none';
            } else {
                regularGroup.style.display = 'flex';
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        // Add debt
        function addDebt() {
            const name = document.getElementById('newDebtName').value;
            const initial = parseFloat(document.getElementById('newDebtInitial').value);
            const current = parseFloat(document.getElementById('newDebtCurrent').value);
            const frequency = document.getElementById('newDebtFrequency').value;
            const paymentType = document.getElementById('newDebtPaymentType').value;
            const regularPayment = paymentType === 'regular' ? parseFloat(document.getElementById('newDebtPayment').value) : null;

            if (!name || !initial || !current) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            if (paymentType === 'regular' && !regularPayment) {
                alert('Por favor ingresa el monto del pago regular');
                return;
            }

            debts.push({
                id: Date.now(),
                name,
                initialAmount: initial,
                currentAmount: current,
                frequency,
                paymentType,
                regularPayment,
                paid: initial - current,
                payments: [] // Array para guardar el historial de pagos irregulares
            });

            // Sort by current amount (snowball method - smallest first)
            debts.sort((a, b) => a.currentAmount - b.currentAmount);

            saveData();
            render();

            // Clear form
            document.getElementById('newDebtName').value = '';
            document.getElementById('newDebtInitial').value = '';
            document.getElementById('newDebtCurrent').value = '';
            document.getElementById('newDebtPayment').value = '';
            document.getElementById('newDebtPaymentType').value = 'regular';
            togglePaymentType();
            
            // Collapse the add debt section
            toggleSection('addDebtSection');
        }

        // Make payment
        function makePayment(debtId, isManual = false) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            let amount;
            if (isManual) {
                const input = document.getElementById(`manual-${debtId}`);
                amount = parseFloat(input.value);
                if (!amount || amount <= 0) {
                    alert('Ingresa un monto v√°lido');
                    return;
                }
                input.value = '';
            } else {
                const input = document.getElementById(`payment-${debtId}`);
                amount = parseFloat(input.value);
                if (!amount || amount <= 0) {
                    alert('Ingresa un monto v√°lido');
                    return;
                }
            }

            debt.currentAmount -= amount;
            debt.paid += amount;

            if (debt.currentAmount <= 0) {
                debt.currentAmount = 0;
                showCelebration();
                // Delete the debt after celebration
                setTimeout(() => {
                    debts = debts.filter(d => d.id !== debtId);
                    saveData();
                    render();
                }, 100);
            } else {
                saveData();
                render();
            }
        }

        // Quick payment with regular amount
        function quickPayment(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            const amount = debt.regularPayment;
            debt.currentAmount -= amount;
            debt.paid += amount;

            if (debt.currentAmount <= 0) {
                debt.currentAmount = 0;
                showCelebration();
                // Delete the debt after celebration
                setTimeout(() => {
                    debts = debts.filter(d => d.id !== debtId);
                    saveData();
                    render();
                }, 100);
            } else {
                saveData();
                render();
            }
        }

        // Extra payment modal
        let currentExtraPaymentDebtId = null;

        function openExtraPaymentModal(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            currentExtraPaymentDebtId = debtId;
            document.getElementById('modalDebtName').textContent = debt.name;
            document.getElementById('modalCurrentBalance').textContent = formatCurrency(debt.currentAmount);
            document.getElementById('modalNewBalance').value = '';
            
            document.getElementById('overlay').classList.add('show');
            document.getElementById('extraPaymentModal').classList.add('show');
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('modalNewBalance').focus();
            }, 100);
        }

        function closeExtraPaymentModal() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('extraPaymentModal').classList.remove('show');
            currentExtraPaymentDebtId = null;
        }

        function confirmExtraPayment() {
            if (!currentExtraPaymentDebtId) return;

            const newBalance = parseFloat(document.getElementById('modalNewBalance').value);
            
            if (isNaN(newBalance) || newBalance < 0) {
                alert('Por favor ingresa un saldo v√°lido');
                return;
            }

            const debt = debts.find(d => d.id === currentExtraPaymentDebtId);
            if (!debt) return;

            // Update the debt
            const oldBalance = debt.currentAmount;
            debt.currentAmount = newBalance;
            debt.paid = debt.initialAmount - newBalance;

            closeExtraPaymentModal();

            if (debt.currentAmount === 0) {
                showCelebration();
                // Delete the debt after celebration
                setTimeout(() => {
                    debts = debts.filter(d => d.id === currentExtraPaymentDebtId);
                    saveData();
                    render();
                }, 100);
            } else {
                saveData();
                render();
            }
        }

        // Allow Enter key to submit in modal
        document.addEventListener('DOMContentLoaded', function() {
            const modalInput = document.getElementById('modalNewBalance');
            if (modalInput) {
                modalInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmExtraPayment();
                    }
                });
            }
        });

        // Update current amount manually
        function updateAmount(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            const input = document.getElementById(`current-${debtId}`);
            const newAmount = parseFloat(input.value);

            if (isNaN(newAmount) || newAmount < 0) {
                alert('Ingresa un monto v√°lido');
                return;
            }

            debt.paid = debt.initialAmount - newAmount;
            debt.currentAmount = newAmount;

            if (debt.currentAmount === 0) {
                showCelebration();
                // Delete the debt after celebration
                setTimeout(() => {
                    debts = debts.filter(d => d.id !== debtId);
                    saveData();
                    render();
                }, 100);
            } else {
                saveData();
                render();
            }
        }

        // Delete debt
        function deleteDebt(debtId) {
            if (!confirm('¬øEst√°s seguro de eliminar esta deuda?')) return;
            debts = debts.filter(d => d.id !== debtId);
            saveData();
            render();
        }

        // Show celebration
        function showCelebration() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('celebration').classList.add('show');
        }

        // Close celebration
        function closeCelebration() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('celebration').classList.remove('show');
        }

        // Close any open modal when clicking overlay
        function closeModals() {
            closeCelebration();
            closeExtraPaymentModal();
        }

        // Toggle sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const isCollapsed = section.classList.contains('collapsed');
            
            if (isCollapsed) {
                section.classList.remove('collapsed');
                section.style.maxHeight = section.scrollHeight + 'px';
                section.style.opacity = '1';
                section.style.marginBottom = '40px';
            } else {
                section.style.maxHeight = '0';
                section.style.opacity = '0';
                section.style.marginBottom = '0';
                setTimeout(() => {
                    section.classList.add('collapsed');
                }, 400);
            }
        }

        // Toggle individual debt
        function toggleDebt(debtId) {
            const content = document.getElementById(`content-${debtId}`);
            const icon = document.getElementById(`icon-${debtId}`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        // Initialize debts as collapsed
        function initializeCollapsedState() {
            debts.forEach(debt => {
                const content = document.getElementById(`content-${debt.id}`);
                const icon = document.getElementById(`icon-${debt.id}`);
                if (content && icon) {
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                }
            });
        }

        // Render regular payment section
        function renderRegularPayments(debt) {
            return `
                <div class="payment-form">
                    <div class="form-title">üí° Registrar Pago Regular</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monto del Pago</label>
                            <input type="number" id="payment-${debt.id}" placeholder="500.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="makePayment(${debt.id})">Aplicar Pago</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <button class="btn-secondary" onclick="quickPayment(${debt.id})" style="width: 100%;">
                            ‚ö° Pago R√°pido: ${formatCurrency(debt.regularPayment)}
                        </button>
                        <button onclick="openExtraPaymentModal(${debt.id})" 
                                style="width: 100%; background: linear-gradient(135deg, var(--accent-yellow) 0%, #f5d88a 100%); 
                                       color: var(--primary); border: none; padding: 12px; border-radius: 8px; 
                                       font-family: 'Oswald', sans-serif; font-weight: 600; text-transform: uppercase; 
                                       cursor: pointer; font-size: 0.95rem; transition: all 0.3s ease;">
                            üí∞ Pago Adelantado
                        </button>
                    </div>
                </div>
            `;
        }

        // Render irregular payment section
        function renderIrregularPayments(debt) {
            const paymentsHistory = debt.payments.map((payment, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-main); border-radius: 6px; margin-bottom: 8px;">
                    <span style="color: var(--text-medium);">Pago ${index + 1}</span>
                    <span style="font-family: 'Oswald', sans-serif; font-size: 1.2rem; color: var(--accent-green); font-weight: 600;">
                        ${formatCurrency(payment.amount)}
                    </span>
                    <span style="font-size: 0.85rem; color: var(--text-light);">${payment.date}</span>
                </div>
            `).join('');

            return `
                <div class="payment-form" style="background: linear-gradient(135deg, #e8f4ff 0%, var(--bg-main) 100%); border: 2px solid var(--accent-blue);">
                    <div class="form-title" style="color: var(--primary);">üìä Pagos Irregulares</div>
                    <p style="color: var(--text-medium); font-size: 0.9rem; margin-bottom: 15px;">
                        Esta deuda no tiene un pago fijo. Registra cada pago cuando lo hagas.
                    </p>
                    
                    ${debt.payments.length > 0 ? `
                        <div style="margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                            <h4 style="font-size: 0.95rem; color: var(--text-medium); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Historial de Pagos:
                            </h4>
                            ${paymentsHistory}
                        </div>
                    ` : ''}
                    
                    <div class="form-title" style="font-size: 1.1rem; margin-top: 20px;">Registrar nuevo pago</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monto del Pago ${debt.payments.length + 1}</label>
                            <input type="number" id="irregular-payment-${debt.id}" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="addIrregularPayment(${debt.id})">
                                ‚úÖ Registrar Pago ${debt.payments.length + 1}
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="openExtraPaymentModal(${debt.id})" 
                            style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, var(--accent-yellow) 0%, #f5d88a 100%); 
                                   color: var(--primary); border: none; padding: 12px; border-radius: 8px; 
                                   font-family: 'Oswald', sans-serif; font-weight: 600; text-transform: uppercase; 
                                   cursor: pointer; font-size: 0.95rem; transition: all 0.3s ease;">
                        üí∞ Actualizar Saldo Total
                    </button>
                </div>
            `;
        }

        // Add irregular payment
        function addIrregularPayment(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;

            const input = document.getElementById(`irregular-payment-${debtId}`);
            const amount = parseFloat(input.value);

            if (!amount || amount <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            // Add payment to history
            const today = new Date().toLocaleDateString('es-MX');
            debt.payments.push({
                amount,
                date: today
            });

            // Update debt amounts
            debt.currentAmount -= amount;
            debt.paid += amount;

            if (debt.currentAmount <= 0) {
                debt.currentAmount = 0;
                showCelebration();
                // Delete the debt after celebration
                setTimeout(() => {
                    debts = debts.filter(d => d.id !== debtId);
                    saveData();
                    render();
                }, 100);
            } else {
                saveData();
                render();
            }
        }

        // Render everything
        function render() {
            // Calculate totals
            const totalDebt = debts.reduce((sum, d) => sum + d.currentAmount, 0);
            const totalInitial = debts.reduce((sum, d) => sum + d.initialAmount, 0);
            const totalPaid = debts.reduce((sum, d) => sum + d.paid, 0);
            const activeDebts = debts.filter(d => d.currentAmount > 0).length;
            const progress = totalInitial > 0 ? ((totalPaid / totalInitial) * 100).toFixed(1) : 0;

            // Update overview
            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
            document.getElementById('activeDebts').textContent = activeDebts;
            document.getElementById('totalProgress').textContent = `${progress}%`;
            document.getElementById('totalProgressBar').style.width = `${progress}%`;

            // Render debts
            const container = document.getElementById('debtsContainer');
            container.innerHTML = debts.map((debt, index) => {
                const debtProgress = ((debt.paid / debt.initialAmount) * 100).toFixed(1);
                const isPriority = index === 0 && debt.currentAmount > 0;
                const isIrregular = debt.paymentType === 'irregular';
                
                // Ensure payments array exists (for old debts)
                if (!debt.payments) debt.payments = [];

                return `
                    <div class="debt-card ${isPriority ? 'priority' : ''}">
                        <div class="debt-header collapsible-header" onclick="toggleDebt(${debt.id})">
                            <div class="debt-name">
                                ${debt.name}
                                ${isPriority ? '<span class="priority-badge">üéØ Prioridad</span>' : ''}
                                ${isIrregular ? '<span class="priority-badge" style="background: var(--accent-blue);">üìä Irregular</span>' : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="text-align: right;">
                                    <div style="font-size: 0.85rem; color: var(--text-medium);">Saldo actual</div>
                                    <div style="font-family: 'Oswald', sans-serif; font-size: 1.5rem; color: var(--accent-red); font-weight: 700;">
                                        ${formatCurrency(debt.currentAmount)}
                                    </div>
                                </div>
                                <span class="collapse-icon" id="icon-${debt.id}">‚ñº</span>
                            </div>
                        </div>

                        <div class="collapsible-content" id="content-${debt.id}">
                        <div class="debt-info">
                            <div class="info-item">
                                <span class="info-label">Deuda Inicial</span>
                                <span class="info-value">${formatCurrency(debt.initialAmount)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Saldo Actual</span>
                                <span class="info-value">${formatCurrency(debt.currentAmount)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ya Pagado</span>
                                <span class="info-value" style="color: var(--accent-green);">${formatCurrency(debt.paid)}</span>
                            </div>
                            ${!isIrregular ? `
                            <div class="info-item">
                                <span class="info-label">Pago ${debt.frequency}</span>
                                <span class="info-value" style="color: var(--accent-yellow); font-size: 1.3rem;">${formatCurrency(debt.regularPayment)}</span>
                            </div>
                            ` : `
                            <div class="info-item">
                                <span class="info-label">Pagos Registrados</span>
                                <span class="info-value" style="color: var(--accent-blue); font-size: 1.3rem;">${debt.payments.length}</span>
                            </div>
                            `}
                        </div>

                        <div class="debt-progress">
                            <div class="debt-progress-bar">
                                <div class="debt-progress-fill" style="width: ${debtProgress}%"></div>
                            </div>
                            <div class="debt-progress-text">
                                <span>Progreso: ${debtProgress}%</span>
                                <span>Falta: ${formatCurrency(debt.currentAmount)}</span>
                            </div>
                        </div>

                        ${isIrregular ? renderIrregularPayments(debt) : renderRegularPayments(debt)}
                        
                        <button class="btn-danger" onclick="deleteDebt(${debt.id}); event.stopPropagation();" style="width: 100%; margin-top: 15px;">
                            Eliminar Deuda
                        </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize collapsed state for all debts
            setTimeout(initializeCollapsedState, 50);
        }

        // Initialize
        loadData();
    </script>

    <!-- Service Worker Registration -->
    <script>
        // PWA Install prompt
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install button
            installButton.style.display = 'inline-block';
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Clear the deferredPrompt variable
                deferredPrompt = null;
                // Hide the install button
                installButton.style.display = 'none';
            }
        });

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Error al registrar Service Worker:', err));
            });
        }
    </script>
</body>
</html>